<!doctype html>
<html lang="en">
	<head>
		<title>Meshmill</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/style.css">
	</head>
	<body>
        <div id="app">
            <div id="tabs">
                <button id="model-tab" class="tab">MODEL</button>
                <div id="jobtabs"></div>
                <button id="addjob-tab" class="tab">+<br>ADD JOB</button>
            </div>

            <div id="options">
                <div id="model-options">
                    Model: <input id="stlfile" type="file"><br>
                    <button>Reload from disk</button>
                    <hr>
                    Bounds:<br>
                    X: -5 to 65 (70)<br>
                    Y: -10 to 70 (80)<br>
                    Z: 0 to 10 (10)<br>
                    <hr>
                    XY Resolution: 0.1mm<br>
                    Heightmap: 2000x5000 px<br>
                    <hr>
                    <button id="render-heightmap">Render heightmap</button><br>
                    <span id="model-pct">60%</span> | ETA: <span id="model-eta">10 sec</span><br>
                </div>

                <div id="toolpath-options" style="display:none">
                    Tool shape: <span id="toolshape"></span><br>
                    Tool diameter: <span id="tooldiameter"></span>mm<br>
                    X/Y feed rate: <span id="xyfeed"></span>mm/min<br>
                    Z feed rate: <span id="zfeed"></span>mm/min<br>
                    Safe Z: <span id="safez"></span>mm<br>
                    Spindle: <span id="rpm"></span> rpm<br>
                    <hr>
                    Cut direction: <span id="direction"></span><br>
                    Step over: <span id="stepover"></span>mm<br>
                    Step down: <span id="stepdown"></span>mm<br>
                    Clearance: <span id="clearance"></span>mm<br>
                    <hr>
                    Roughing only<br>
                    Ramp entry<br>
                    Omit top<br>
                    <hr>
                    <button>Generate toolpath</button><br>
                    <span id="toolpath-pct">60%</span> | ETA: <span id="toolpath-eta">10 sec</span><br>
                    <button>Save G-code</button> | <button id="deletejob">Delete job</button><br>
                    Cycle time estimate: <span id="cycletime">45m23s</span><br>
                </div>
            </div>

            <div id="scene"></div>
        </div>

		<script src="js/lib/three.min.js"></script>
        <script src="js/lib/STLLoader.js"></script>
        <script src="js/lib/OrbitControls.js"></script>
		<script src="js/lib/jquery-3.6.0.min.js"></script>
        <script src="js/project.js"></script>
        <script src="js/ui.js"></script>

		<script>
            redrawTabs();

			var container;

			var camera, scene, renderer;

			var mesh;

            STLViewer("/home/jes/cad/sake-set/insert.stl", "scene");

			function STLViewer(model, element) {
				container = document.getElementById(element);
                var elem = container;

                camera = new THREE.PerspectiveCamera(70, 
    elem.clientWidth/elem.clientHeight, 1, 1000);




				renderer = new THREE.WebGLRenderer( { antialias: false, alpha : true } );
				renderer.setClearColor(0x000000, 0);
				// renderer.setClearColor( scene.fog.color );
				renderer.setPixelRatio( window.devicePixelRatio );
				//renderer.setSize( container.clientWidth, container.clientHeight );

				// renderer.gammaInput = true;
				// renderer.gammaOutput = true;

				container.appendChild( renderer.domElement );

				//

				window.addEventListener( 'resize', onWindowResize, false );
                onWindowResize();

var controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.rotateSpeed = 0.25;
controls.dampingFactor = 0.9;
controls.enableZoom = true;
controls.autoRotate = false;
controls.autoRotateSpeed = .75;

var scene = new THREE.Scene();
scene.add(new THREE.AmbientLight(0xffffff,0.5));
var l = new THREE.DirectionalLight(0xffffff, 1.5);
l.position.set(0.5, 0.6, 0.7);
scene.add(l);

(new THREE.STLLoader()).load(model, function (geometry) {
    var material = new THREE.MeshPhongMaterial({ 
        color: 0x186467,
    });
    var mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

var middle = new THREE.Vector3();
geometry.computeBoundingBox();
geometry.boundingBox.getCenter(middle);
mesh.geometry.applyMatrix(new THREE.Matrix4().makeTranslation( 
                              -middle.x, -middle.y, -middle.z ) );

var largestDimension = Math.max(geometry.boundingBox.max.x,
                            geometry.boundingBox.max.y, 
                            geometry.boundingBox.max.z)
camera.position.z = largestDimension * 1.5;

var animate = function () {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}; 

animate();
});

			}

			function onWindowResize() {
                renderer.setSize(0,0);
                let rect = container.getBoundingClientRect();
				camera.aspect = rect.width / rect.height;
				camera.updateProjectionMatrix();
				renderer.setSize(rect.width, rect.height);
			}
		</script>
	</body>
</html>

